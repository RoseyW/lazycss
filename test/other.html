<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

</body>
<script>

    function setReactiveValue(obj, path, target, value){
        console.log("best",obj, path, target, value);
        let k = Object.keys(path);
        if(k.length > 0){
            obj = JSON.parse(JSON.stringify(obj));
            if (obj && obj[path[k[0]]]){
                let k0 = k[0];
                k.shift();
                obj[path[k[0]]] = setReactiveValue(obj[path[k0]], k, target, value);
            }

        } else {
            obj[target] = value;
        }
        return obj;
    }

    function proxyControl(target, prototype, time) {
        console.log("123",target,prototype,time);
        switch(time){
            case 0:
                //找namespace
                if(target !== "__media"){
                    window.cssBeta.__cache.chainPath.block = "__style";//include __style/__media/__unit
                    //为style
                    let namespaceKey = Object.keys(window.cssBeta.__style);
                    console.log(namespaceKey);
                    let a = namespaceKey.indexOf(prototype);
                    if(a > -1){
                        //存在
                        window.cssBeta.__cache.chainPath.namespace = prototype;
                        return false;
                    } else {
                        window.cssBeta.__cache.chainPath.namespace = "__default";
                        window.cssBeta.__cache.chainTimes++;
                        proxyControl(target, prototype, window.cssBeta.__cache.chainTimes);
                        return false;
                    }
                }
                break;
            case 1:
                //找css类名
                let cssClass = window.cssBeta.__style[window.cssBeta.__cache.chainPath.namespace];
                let cssClassKey = Object.keys(cssClass);
                let b = cssClassKey.indexOf(prototype);
                if(b > -1){
                    window.cssBeta.__cache.chainPath.cssName = prototype;
                    return false;
                } else {
                    return false;
                }
            case 2:
                let itemTag = window.cssBeta.__style[window.cssBeta.__cache.chainPath.namespace][window.cssBeta.__cache.chainPath.cssName];
                let itemTagKey = Object.keys(itemTag);
                let c = itemTagKey.indexOf(prototype);

                clearGlobalCache();

                if(c > -1){
                    return itemTag[prototype];
                } else {
                    return null;
                }
            default:
                throw Error("error");
        }
    }

    function deepFreeze(obj) {
        if (typeof obj != 'object') {
            throw Error('Type Error!')
        }
        Object.freeze(obj);
        for (const key in obj) {
            if (Object.hasOwnProperty.call(obj, key)) {
                if (typeof obj[key] === 'object') {
                    deepFreeze(obj[key])
                }
            }
        }
    }

    function init(){

        let __style = {
            rosey: {
                demo: {
                    width: 30
                }
            }
        }

        createGlobalVariable({ __style });

        return window.cssBeta.__proxy;
    }

    function clearGlobalCache(){
        let __cache = {
            chainTimes:0,
            chainPath:{}
        }

        createGlobalVariable(__cache);
    }

    function createGlobalVariable({...objList} = {}){

        console.log(objList);

        console.log("cgv", window.cssBeta);

        let __style = window.cssBeta?.__style !== undefined ? Object.assign(window.cssBeta.__style) : {};
        let __media = window.cssBeta?.__media !== undefined ? Object.assign(window.cssBeta.__media) : {};
        let __unit = window.cssBeta?.__unit !== undefined ? Object.assign(window.cssBeta.__unit) : {};
        let __cache = window.cssBeta?.__cache !== undefined ? Object.assign(window.cssBeta.__cache) : {
            chainTimes:0,
            chainPath:{}
        };

        console.log("sgv_style",__style);

        deepFreeze(__style);
        deepFreeze(__media);
        deepFreeze(__unit);

        window.cssBeta = {
            __style,
            __media,
            __unit,
            __cache,
            __proxy: getProxy(__style, __media)
        }

        if(JSON.stringify(objList) !== "{}"){
            for (const objListKey in objList) {
                window.cssBeta[objListKey] = objList[objListKey];
            }
        }


        console.log(window.cssBeta);
    }

    function getProxy(__style, __media){
        console.log("getProxy");
        return new Proxy({
            __style,
            __media
        }, {
            get(target, p) {
                let c = proxyControl(target,p,window.cssBeta.__cache.chainTimes);
                if(c !== false){
                    return c;
                } else {
                    window.cssBeta.__cache.chainTimes++;
                    return window.cssBeta.__proxy;
                }
            },
            set(target, p, value, receiver) {
                console.log(target, p, value, receiver);
                let obj = setReactiveValue(window.cssBeta, window.cssBeta.__cache.chainPath, p, value);
                console.log("obj",obj);
                createGlobalVariable({ __style: obj.__style });
                clearGlobalCache();
                return window.cssBeta.__proxy;
            }
        });
    }

    let t = {
        global: {
            __style:{},
            __unit:{}
        },
        //proxy直接映射global，每次更新进行粒子化操作
        proxy: {

        }
    }

    window.lazyTest = {
        global: {
            __style:{},
            __unit:{}
        },
        //proxy直接映射global，每次更新进行粒子化操作
        proxy: g_getProxy(),
        //全局缓存
        cache: {

        }
    }

    function createBaseGlobal(){

    }

    function g_getProxy(){
        return new Proxy({}, {
            set(target, p, value, receiver) {
            },
            get(target, p, receiver) {
            }
        })
    }

    //要求，创建代理需要将global内所有的选项都加入
    //通用化方法

    let cssBeta = init();
    console.log(cssBeta);
    console.time("bbc");
    cssBeta.rosey.demo.width = 445;
    console.log(window.cssBeta);
    console.timeEnd("bbc");
</script>
</html>
